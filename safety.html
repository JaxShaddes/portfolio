<!DOCTYPE html>
<html lang="en" class="antialiased bg-[#f4f4f0] text-[#111]">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Client Access — Bruno Clemente</title>
  <meta name="description" content="Client project access portal." />

  <!-- Fonts (matches your site vibe) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Tailwind (same pattern as your portfolio) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
            display: ['Space Grotesk', 'sans-serif'],
          },
          colors: {
            'off-white': '#f4f4f0',
            'black': '#111111',
            'accent': 'var(--accent-color, #FF3300)',
            'gray-light': '#e5e5e5',
          },
          spacing: { '128': '32rem' }
        }
      }
    }
  </script>

  <style>
    :root {
      --accent-color: #4b5670; /* your default accent */
      --cursor-size: 20px;
    }

    body { overflow-x: hidden; }

/* Only hide the system cursor when there is a fine pointer (mouse/trackpad) */
@media (pointer: fine) {
  body.custom-cursor { cursor: none; }
  body.custom-cursor a,
  body.custom-cursor button,
  body.custom-cursor .interactive,
  body.custom-cursor input,
  body.custom-cursor label,
  body.custom-cursor summary { cursor: none; }
}

/* On touch devices, don’t show the custom cursor at all */
@media (pointer: coarse) {
  #cursor { display: none; }
}
    /* Custom Cursor */
    #cursor {
      position: fixed;
      top: 0; left: 0;
      width: var(--cursor-size);
      height: var(--cursor-size);
      background: #111111;
      border-radius: 50%;
      pointer-events: none;
      z-index: 9999;
      transform: translate(-50%, -50%);
      mix-blend-mode: normal;
      box-shadow: 0 0 0 2px rgba(244,244,240,0.9);
      transition: width 0.3s, height 0.3s, background-color 0.3s, opacity 0.2s;
    }
    #cursor.hovered {
      width: 60px;
      height: 60px;
      background: #f4f4f0;
      mix-blend-mode: normal;
      box-shadow: 0 0 0 2px rgba(17,17,17,0.2);
    }
    #cursor.hidden { opacity: 0; }

    /* Background grid overlay */
    .grid-overlay {
      background-size: 100px 100px;
      background-image:
        linear-gradient(to right, rgba(0, 0, 0, 0.05) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(0, 0, 0, 0.05) 1px, transparent 1px);
      pointer-events: none;
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #f4f4f0; }
    ::-webkit-scrollbar-thumb { background: #111; border: 2px solid #f4f4f0; }

    /* Premium-ish inputs */
    .field {
      outline: none;
      transition: box-shadow .2s, border-color .2s, transform .2s;
    }
    .field:focus {
      border-color: rgba(17,17,17,.9);
      box-shadow: 0 0 0 4px rgba(75,86,112,.15);
    }

    /* Locked screen visuals */
    .scanline { animation: scan 3.6s linear infinite; }
    @keyframes scan {
      0% { transform: translateY(-20%); opacity: 0; }
      10% { opacity: 0.8; }
      55% { opacity: 0.5; }
      100% { transform: translateY(120%); opacity: 0; }
    }
    .pulse-dot { animation: pulse 1.8s ease-in-out infinite; }
    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 0.6; }
      50% { transform: scale(1.4); opacity: 1; }
    }
  </style>
</head>

<body class="min-h-screen">
  <div id="cursor"></div>
  <div class="fixed inset-0 grid-overlay opacity-60"></div>

  <!-- NAV -->
  <nav class="fixed top-0 left-0 w-full z-50 flex justify-between items-center px-6 py-6 mix-blend-difference text-[#f4f4f0]">
    <a href="./index.html"
       class="font-display font-bold text-xl tracking-tighter uppercase cursor-pointer interactive hidden md:block hover:text-accent transition-colors">
      Bruno Clemente
    </a>
    <a href="./index.html"
       class="font-display font-bold text-xl tracking-tighter uppercase cursor-pointer interactive md:hidden hover:text-accent transition-colors">
      BC
    </a>

    <div class="flex gap-4 md:gap-8 font-sans text-xs md:text-sm uppercase tracking-widest">
      <a href="./index.html" class="hover:text-accent transition-colors interactive" data-i18n="nav.back">Back</a>
      <button id="lockBtn" class="hover:text-accent transition-colors interactive hidden" type="button" data-i18n="nav.lock">Lock</button>
      <a id="openNewTabLink" href="#" target="_blank" rel="noopener"
         class="hover:text-accent transition-colors interactive hidden" data-i18n="nav.open">Open</a>
    </div>
  </nav>

  <main class="relative pt-28 md:pt-32 px-6 pb-16">
    <div class="max-w-5xl mx-auto">

      <div class="mb-10 md:mb-14">
        <div class="font-display uppercase tracking-[0.25em] text-xs mb-3 opacity-70" data-i18n="hero.kicker">Client Portal</div>
        <h1 class="font-display font-bold tracking-tighter text-4xl md:text-6xl leading-[0.95]">
          <span data-i18n="hero.title">Client Access</span>
        </h1>
        <p class="mt-4 max-w-2xl text-sm md:text-base opacity-80" data-i18n-html="hero.subtitle">
          Welcome, <span id="clientName">client</span>. Your project is our priority, and everything you need is right below.
        </p>
      </div>

      <section class="grid md:grid-cols-5 gap-6 md:gap-8 items-start">
        <!-- Gate -->
        <div class="md:col-span-2">
          <div class="border border-black/10 bg-white/40 backdrop-blur-sm rounded-2xl p-6 md:p-7 shadow-sm">
            <div class="flex items-center justify-between">
              <h2 class="font-display font-bold tracking-tight text-xl" data-i18n="gate.title">Unlock</h2>
              <span id="chip" class="text-xs uppercase tracking-widest opacity-60" data-i18n="gate.protected">Protected</span>
            </div>

            <p id="contextLine" class="mt-3 text-sm opacity-80">
              Provide a link with <span class="font-mono text-xs">?id=client</span>
            </p>

            <label class="block mt-5 text-xs uppercase tracking-widest opacity-70" for="password" data-i18n="gate.passwordLabel">
              Password
            </label>

            <div class="mt-2 flex gap-2">
              <input id="password" type="password" autocomplete="current-password"
                     class="field w-full px-4 py-3 rounded-xl border border-black/10 bg-[#f4f4f0] text-black font-sans text-sm interactive"
                     placeholder="Enter password" data-i18n-placeholder="gate.passwordPlaceholder" />
              <button id="togglePw" type="button"
                      class="px-4 py-3 rounded-xl border border-black/10 bg-white/60 hover:bg-white transition-colors text-xs uppercase tracking-widest interactive">
                <span data-i18n="gate.toggleShow">Show</span>
              </button>
            </div>

            <div class="mt-4 flex items-center justify-between gap-3">
              <label class="flex items-center gap-2 text-sm opacity-80 cursor-pointer select-none interactive">
                <input id="remember" type="checkbox" class="accent-black" />
                <span data-i18n="gate.remember">Remember (24h)</span>
              </label>

              <button id="unlockBtn" type="button"
                      class="px-5 py-3 rounded-xl bg-black text-[#f4f4f0] hover:bg-[#111] transition-colors font-sans text-xs uppercase tracking-widest interactive">
                <span data-i18n="gate.unlock">Unlock</span>
              </button>
            </div>

            <div id="status" class="mt-4 text-sm opacity-80 min-h-[1.5rem]"></div>

            <div id="clientLogoWrap" class="mt-5 hidden">
              <div class="text-[10px] uppercase tracking-widest opacity-60 mb-2" data-i18n="gate.clientLabel">Client</div>
                   <div class="rounded-xl border border-black/10 bg-white/60 px-4 py-3">
                <img id="clientLogo" alt="Client logo" class="w-full h-auto object-contain" />
              </div>
            </div>

          </div>
        </div>

        <!-- Viewer -->
        <div class="md:col-span-3">
          <div id="viewerShell"
               class="border border-black/10 bg-white/30 backdrop-blur-sm rounded-2xl shadow-sm overflow-hidden hidden">
            <div class="flex items-center justify-between px-5 py-4 border-b border-black/10">
              <div>
                <div class="font-display font-bold tracking-tight text-lg" data-i18n="viewer.title">Project Viewer</div>
                <div id="viewerSub" class="text-xs uppercase tracking-widest opacity-60 mt-1"></div>
              </div>
              <div class="flex items-center gap-2">
                <span id="embedStatus" class="text-xs uppercase tracking-widest opacity-60"></span>
                <div class="hidden md:flex items-center gap-2 text-[10px] uppercase tracking-widest">
                  <button id="sizeMobile" type="button"
                          class="px-3 py-2 rounded-lg border border-black/10 bg-white/60 hover:bg-white transition-colors interactive">
                    <span data-i18n="viewer.mobile">Mobile</span>
                  </button>
                  <button id="sizeTablet" type="button"
                          class="px-3 py-2 rounded-lg border border-black/10 bg-white/60 hover:bg-white transition-colors interactive">
                    <span data-i18n="viewer.tablet">Tablet</span>
                  </button>
                  <button id="sizeDesktop" type="button"
                          class="px-3 py-2 rounded-lg border border-black/10 bg-white/60 hover:bg-white transition-colors interactive">
                    <span data-i18n="viewer.desktop">Desktop</span>
                  </button>
                </div>
              </div>
            </div>

            <div class="p-4 md:p-5">
              <div id="frameShell" class="rounded-2xl overflow-hidden border border-black/10 bg-[#f4f4f0]">
                <iframe id="projectFrame"
                        title="Client Project"
                        class="w-full block"
                        style="height: 70vh; min-height: 420px; max-height: 85vh;"
                        referrerpolicy="no-referrer"
                        loading="eager"></iframe>
              </div>

              <div id="fallback" class="mt-4 hidden border border-black/10 bg-white/50 rounded-2xl p-4">
                <div class="font-display font-bold tracking-tight" data-i18n="viewer.fallback.title">Can’t embed this project</div>
                <p class="mt-2 text-sm opacity-80" data-i18n="viewer.fallback.body">
                  The project may block embedding (X-Frame-Options / CSP frame-ancestors). Use the button below.
                </p>
                <a id="fallbackOpen"
                   class="inline-flex mt-3 px-5 py-3 rounded-xl bg-black text-[#f4f4f0] hover:bg-[#111] transition-colors font-sans text-xs uppercase tracking-widest interactive"
                   href="#" target="_blank" rel="noopener">
                  <span data-i18n="viewer.fallback.open">Open in new tab</span>
                </a>
              </div>
            </div>
          </div>

          <!-- Empty/error state -->
          <div id="emptyState"
               class="border border-black/10 bg-white/40 backdrop-blur-sm rounded-2xl p-6 md:p-7 shadow-sm">
            <div class="relative overflow-hidden rounded-2xl border border-white/10 bg-[#0b0f14] text-[#e7eef7] p-6 md:p-7">
              <div class="absolute inset-0 opacity-40 pointer-events-none"
                   style="background-image: radial-gradient(80% 60% at 50% 0%, rgba(77,118,255,0.35), transparent 60%), radial-gradient(60% 80% at 100% 100%, rgba(0,255,180,0.12), transparent 70%);">
              </div>
              <div class="absolute inset-0 opacity-25 pointer-events-none"
                   style="background-image: linear-gradient(to right, rgba(255,255,255,0.06) 1px, transparent 1px), linear-gradient(to bottom, rgba(255,255,255,0.06) 1px, transparent 1px); background-size: 48px 48px;">
              </div>
              <div class="scanline absolute left-0 right-0 h-px bg-gradient-to-r from-transparent via-[#8fb2ff] to-transparent"></div>

              <div class="relative">
                <div class="flex items-center justify-between gap-4">
                  <div class="flex items-center gap-3">
                    <div class="h-11 w-11 rounded-full border border-white/15 bg-white/5 flex items-center justify-center">
                      <svg viewBox="0 0 24 24" class="h-5 w-5" fill="none" stroke="#c9d7ff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <rect x="5" y="10" width="14" height="10" rx="2"></rect>
                        <path d="M8 10V7a4 4 0 0 1 8 0v3"></path>
                      </svg>
                    </div>
                    <div>
                      <div class="text-xs uppercase tracking-[0.35em] opacity-70" data-i18n="empty.secureNode">Secure Node</div>
                      <div class="font-display text-xl md:text-2xl tracking-tight" data-i18n="empty.accessLocked">Access Locked</div>
                    </div>
                  </div>
                  <div class="flex items-center gap-2 text-[10px] uppercase tracking-[0.3em] opacity-70">
                    <span class="h-2 w-2 rounded-full bg-[#5bffb0] pulse-dot"></span>
                    <span data-i18n="empty.shielded">Shielded</span>
                  </div>
                </div>

                <div class="mt-6 grid grid-cols-2 gap-4 text-xs">
                  <div class="rounded-xl border border-white/10 bg-white/5 p-4">
                    <div class="uppercase tracking-widest opacity-60" data-i18n="empty.stateLabel">State</div>
                    <div class="mt-2 font-mono text-sm" data-i18n="empty.stateValue">LOCKED</div>
                  </div>
                  <div class="rounded-xl border border-white/10 bg-white/5 p-4">
                    <div class="uppercase tracking-widest opacity-60" data-i18n="empty.handshakeLabel">Handshake</div>
                    <div class="mt-2 font-mono text-sm" data-i18n="empty.handshakeValue">Awaiting Token</div>
                  </div>
                </div>

                <div class="mt-6 rounded-xl border border-white/10 bg-white/5 p-4 font-mono text-xs leading-relaxed text-[#b7c6dd]">
                  <div class="opacity-80" data-i18n="empty.log1">&gt; initiating secure session</div>
                  <div class="opacity-60" data-i18n="empty.log2">&gt; device: unknown</div>
                  <div class="opacity-60" data-i18n="empty.log3">&gt; channel: encrypted</div>
                  <div class="opacity-80" data-i18n="empty.log4">&gt; status: locked</div>
                </div>

                <div class="mt-5 text-[11px] uppercase tracking-[0.35em] opacity-50" data-i18n="empty.footer">
                  Client access portal secured
                </div>
              </div>
            </div>
          </div>

        </div>
      </section>

      <div class="mt-14 text-xs uppercase tracking-widest opacity-60">
        <span data-i18n="help.line">Having trouble? Contact João at</span>
        <a class="underline hover:text-accent interactive" href="mailto:work@jbclemente.pt">work@jbclemente.pt</a>
      </div>

    </div>
  </main>

  <div id="lang-modal" class="fixed inset-0 z-[11000] hidden items-center justify-center bg-black/70 px-6">
    <div class="w-full max-w-md border border-black bg-[#f4f4f0] p-6 shadow-[8px_8px_0px_0px_rgba(0,0,0,1)]">
      <div class="font-display text-2xl uppercase tracking-tight mb-2">Choose your language</div>
      <p class="text-sm opacity-70 mb-6">Escolha o idioma preferido</p>
      <div class="flex flex-col gap-3">
        <button type="button" data-lang="pt"
                class="w-full px-4 py-3 border border-black bg-white hover:bg-black hover:text-white transition-colors font-sans text-xs uppercase tracking-widest interactive">
          Português (Portugal)
        </button>
        <button type="button" data-lang="en"
                class="w-full px-4 py-3 border border-black bg-white hover:bg-black hover:text-white transition-colors font-sans text-xs uppercase tracking-widest interactive">
          English (International)
        </button>
      </div>
    </div>
  </div>

  <script>
    /*************************************************************
     * CONFIG (edit this)
     *************************************************************/
    const rememberDurationHours = 24;

    // 1) Add each client here:
    // - id: the URL ?id= value
    // - name: optional label displayed on the page
    // - passwordHashHex: SHA-256 (hex) of the client's password
    // - allowedDomains: optional allowlist of domains for this client (empty = allow any https)
    // - logoUrl: optional logo image URL or path
    //
    // IMPORTANT: This is a front-end gate (privacy), not strong security.
    const CLIENTS = {
      // Example:
      // acme: {
      //   name: "ACME",
      //   passwordHashHex: "PASTE_SHA256_HEX_HERE",
      //   projectUrl: "https://example.com/demo",
      //   allowedDomains: ["example.com"]
      // },

      byBrazil: {
        name: "by Brazil",
        passwordHashHex: "371b67fae05a6362d9b73583be098aeadd69ba165e51b83b9cdafc5819cc7016",
        projectUrl: "client-safe-preview/hqrz/index.html",
        allowedDomains: [],
        logoUrl: "client-logos/by-brazil.png",
      }
    };

    /*************************************************************
     * Helpers
     *************************************************************/
    const $ = (id) => document.getElementById(id);

    const LANG_KEY = "bc_lang";
    const SUPPORTED_LANGS = ["en", "pt"];

    const I18N = {
      en: {
        "meta.title": "Client Access — Bruno Clemente",
        "meta.description": "Client project access portal.",
        "nav.back": "Back",
        "nav.lock": "Lock",
        "nav.open": "Open",
        "hero.kicker": "Client Portal",
        "hero.title": "Client Access",
        "hero.subtitle": "Welcome, <span id=\"clientName\">client</span>. Your project is our priority, and everything you need is right below.",
        "gate.title": "Unlock",
        "gate.protected": "Protected",
        "gate.passwordLabel": "Password",
        "gate.passwordPlaceholder": "Enter password",
        "gate.toggleShow": "Show",
        "gate.toggleHide": "Hide",
        "gate.remember": "Remember (24h)",
        "gate.unlock": "Unlock",
        "gate.clientLabel": "Client",
        "viewer.title": "Project Viewer",
        "viewer.mobile": "Mobile",
        "viewer.tablet": "Tablet",
        "viewer.desktop": "Desktop",
        "viewer.iframeTitle": "Client Project",
        "viewer.fallback.title": "Can't embed this project",
        "viewer.fallback.body": "The project may block embedding (X-Frame-Options / CSP frame-ancestors). Use the button below.",
        "viewer.fallback.open": "Open in new tab",
        "empty.secureNode": "Secure Node",
        "empty.accessLocked": "Access Locked",
        "empty.shielded": "Shielded",
        "empty.stateLabel": "State",
        "empty.stateValue": "LOCKED",
        "empty.handshakeLabel": "Handshake",
        "empty.handshakeValue": "Awaiting Token",
        "empty.log1": "> initiating secure session",
        "empty.log2": "> device: unknown",
        "empty.log3": "> channel: encrypted",
        "empty.log4": "> status: locked",
        "empty.footer": "Client access portal secured",
        "help.line": "Having trouble? Contact João at",
        "chip.missingId": "Missing id",
        "chip.unknownClient": "Unknown client",
        "labels.clientDefault": "client",
        "context.missingIdHtml": "Provide a link with <span class=\"font-mono text-xs\">?id=client</span>",
        "context.unknownIdHtml": "Unknown <span class=\"font-mono text-xs\">id={id}</span>. Add this client to the CLIENTS map in the file.",
        "context.clientLine": "Client: {name}",
        "status.enterPassword": "Please enter the password.",
        "status.checking": "Checking...",
        "status.wrongPassword": "Wrong password.",
        "status.unlocked": "Unlocked.",
        "status.unlockError": "Something went wrong while unlocking.",
        "status.locked": "Locked.",
        "status.unlockedRemembered": "Unlocked (remembered).",
        "status.pageNeedsId": "This page needs ?id=.",
        "status.missingIdLink": "Missing ?id=. Use a client link like: safety.html?id=acme",
        "status.unknownClient": "Unknown client id: {id}. Add it in the CLIENTS map inside the file.",
        "status.missingPasswordHash": "This client isn't configured yet (missing password hash).",
        "status.ready": "Ready. Enter password to load the project.",
        "status.unlockedReason": "Unlocked — {reason}",
        "status.projectUrlMissing": "Missing project URL for this client.",
        "status.projectUrlInvalid": "Invalid project URL or path.",
        "status.projectUrlHttps": "Project must be https:// (http allowed only on localhost for testing).",
        "status.projectDomainNotAllowed": "Project domain not allowed for this client.",
        "viewer.embed.loading": "Loading...",
        "viewer.embed.blocked": "Embed blocked",
        "viewer.embed.loaded": "Loaded"
      },
      pt: {
        "meta.title": "Acesso do Cliente — Bruno Clemente",
        "meta.description": "Portal de acesso a projetos de cliente.",
        "nav.back": "Voltar",
        "nav.lock": "Bloquear",
        "nav.open": "Abrir",
        "hero.kicker": "Portal do Cliente",
        "hero.title": "Acesso do Cliente",
        "hero.subtitle": "Bem-vindo, <span id=\"clientName\">cliente</span>. O teu projeto é a nossa prioridade e tudo o que precisas está logo abaixo.",
        "gate.title": "Desbloquear",
        "gate.protected": "Protegido",
        "gate.passwordLabel": "Palavra-passe",
        "gate.passwordPlaceholder": "Introduz a palavra-passe",
        "gate.toggleShow": "Mostrar",
        "gate.toggleHide": "Ocultar",
        "gate.remember": "Lembrar (24h)",
        "gate.unlock": "Desbloquear",
        "gate.clientLabel": "Cliente",
        "viewer.title": "Visualizador do Projeto",
        "viewer.mobile": "Mobile",
        "viewer.tablet": "Tablet",
        "viewer.desktop": "Desktop",
        "viewer.iframeTitle": "Projeto do Cliente",
        "viewer.fallback.title": "Não é possível incorporar este projeto",
        "viewer.fallback.body": "O projeto pode bloquear a incorporação (X-Frame-Options / CSP frame-ancestors). Usa o botão abaixo.",
        "viewer.fallback.open": "Abrir num novo separador",
        "empty.secureNode": "Nó Seguro",
        "empty.accessLocked": "Acesso Bloqueado",
        "empty.shielded": "Protegido",
        "empty.stateLabel": "Estado",
        "empty.stateValue": "BLOQUEADO",
        "empty.handshakeLabel": "Handshake",
        "empty.handshakeValue": "A aguardar token",
        "empty.log1": "> a iniciar sessão segura",
        "empty.log2": "> dispositivo: desconhecido",
        "empty.log3": "> canal: encriptado",
        "empty.log4": "> estado: bloqueado",
        "empty.footer": "Portal de acesso do cliente protegido",
        "help.line": "Com dificuldades? Contacta o João em",
        "chip.missingId": "ID em falta",
        "chip.unknownClient": "Cliente desconhecido",
        "labels.clientDefault": "cliente",
        "context.missingIdHtml": "Fornece um link com <span class=\"font-mono text-xs\">?id=client</span>",
        "context.unknownIdHtml": "ID desconhecido <span class=\"font-mono text-xs\">id={id}</span>. Adiciona este cliente ao mapa CLIENTS no ficheiro.",
        "context.clientLine": "Cliente: {name}",
        "status.enterPassword": "Por favor, introduz a palavra-passe.",
        "status.checking": "A verificar...",
        "status.wrongPassword": "Palavra-passe incorreta.",
        "status.unlocked": "Desbloqueado.",
        "status.unlockError": "Algo correu mal ao desbloquear.",
        "status.locked": "Bloqueado.",
        "status.unlockedRemembered": "Desbloqueado (lembrado).",
        "status.pageNeedsId": "Esta página precisa de ?id=.",
        "status.missingIdLink": "Falta ?id=. Usa um link de cliente como: safety.html?id=acme",
        "status.unknownClient": "ID de cliente desconhecido: {id}. Adiciona-o ao mapa CLIENTS dentro do ficheiro.",
        "status.missingPasswordHash": "Este cliente ainda não está configurado (falta o hash da palavra-passe).",
        "status.ready": "Pronto. Introduz a palavra-passe para carregar o projeto.",
        "status.unlockedReason": "Desbloqueado — {reason}",
        "status.projectUrlMissing": "Falta o URL do projeto para este cliente.",
        "status.projectUrlInvalid": "URL ou caminho do projeto inválido.",
        "status.projectUrlHttps": "O projeto deve ser https:// (http permitido apenas em localhost para testes).",
        "status.projectDomainNotAllowed": "O domínio do projeto não é permitido para este cliente.",
        "viewer.embed.loading": "A carregar...",
        "viewer.embed.blocked": "Incorporação bloqueada",
        "viewer.embed.loaded": "Carregado"
      }
    };

    const getStoredLang = () => {
      try {
        const stored = localStorage.getItem(LANG_KEY);
        return SUPPORTED_LANGS.includes(stored) ? stored : null;
      } catch {
        return null;
      }
    };

    const storedLang = getStoredLang();
    let currentLang = storedLang || "en";
    const hasLangPref = !!storedLang;

    const setDocumentLang = (lang) => {
      document.documentElement.setAttribute("lang", lang === "pt" ? "pt-PT" : "en");
    };

    const t = (key, vars = {}) => {
      const dict = I18N[currentLang] || I18N.en;
      let str = dict[key] || I18N.en[key] || key;
      return str.replace(/\{(\w+)\}/g, (_, k) => (vars[k] !== undefined ? vars[k] : ""));
    };

    const applyI18n = (lang) => {
      const dict = I18N[lang] || I18N.en;
      document.title = dict["meta.title"];
      const desc = document.querySelector('meta[name="description"]');
      if (desc) desc.setAttribute("content", dict["meta.description"]);
      document.querySelectorAll("[data-i18n]").forEach((el) => {
        const key = el.getAttribute("data-i18n");
        if (dict[key]) el.textContent = dict[key];
      });
      document.querySelectorAll("[data-i18n-html]").forEach((el) => {
        const key = el.getAttribute("data-i18n-html");
        if (dict[key]) el.innerHTML = dict[key];
      });
      document.querySelectorAll("[data-i18n-placeholder]").forEach((el) => {
        const key = el.getAttribute("data-i18n-placeholder");
        if (dict[key]) el.setAttribute("placeholder", dict[key]);
      });
      const frame = $("projectFrame");
      if (frame && dict["viewer.iframeTitle"]) frame.setAttribute("title", dict["viewer.iframeTitle"]);
    };

    const showLangModal = () => {
      const modal = $("lang-modal");
      if (!modal) return;
      modal.classList.remove("hidden");
      modal.classList.add("flex");
      document.body.style.overflow = "hidden";
    };

    const hideLangModal = () => {
      const modal = $("lang-modal");
      if (!modal) return;
      modal.classList.add("hidden");
      modal.classList.remove("flex");
      document.body.style.overflow = "";
    };

    const initLanguage = () => {
      setDocumentLang(currentLang);
      applyI18n(currentLang);
      const modal = $("lang-modal");
      if (modal) {
        modal.querySelectorAll("[data-lang]").forEach((btn) => {
          btn.addEventListener("click", () => {
            const next = btn.getAttribute("data-lang");
            currentLang = SUPPORTED_LANGS.includes(next) ? next : "en";
            try {
              localStorage.setItem(LANG_KEY, currentLang);
            } catch {}
            setDocumentLang(currentLang);
            applyI18n(currentLang);
            renderContext();
            renderStatusHint();
            hideLangModal();
          });
        });
      }
      if (!hasLangPref) showLangModal();
    };

    function setStatus(msg, type = "neutral") {
      const el = $("status");
      const base = "mt-4 text-sm min-h-[1.5rem]";
      const color =
        type === "error" ? "text-red-700" :
        type === "success" ? "text-green-700" :
        "opacity-80";
      el.className = `${base} ${color}`;
      el.textContent = msg || "";
    }

    function safeParseUrl(u) {
      try { return new URL(u); } catch { return null; }
    }

    function hostAllowed(host, allowedDomains) {
      if (!allowedDomains || allowedDomains.length === 0) return true;
      const h = host.toLowerCase();
      return allowedDomains.some(d => {
        const dd = d.toLowerCase();
        return h === dd || h.endsWith("." + dd);
      });
    }

    async function sha256Hex(str) {
      const data = new TextEncoder().encode(str);
      const hash = await crypto.subtle.digest("SHA-256", data);
      return [...new Uint8Array(hash)].map(b => b.toString(16).padStart(2, "0")).join("");
    }

    function rememberKey(clientId) {
      return `client_portal_unlock:${clientId}`;
    }

    function rememberSet(clientId) {
      const exp = Date.now() + rememberDurationHours * 60 * 60 * 1000;
      localStorage.setItem(rememberKey(clientId), JSON.stringify({ exp }));
    }

    function rememberClear(clientId) {
      localStorage.removeItem(rememberKey(clientId));
    }

    function rememberValid(clientId) {
      try {
        const raw = localStorage.getItem(rememberKey(clientId));
        if (!raw) return false;
        const obj = JSON.parse(raw);
        return obj && typeof obj.exp === "number" && Date.now() < obj.exp;
      } catch {
        return false;
      }
    }

    function updateOpenLinks(url) {
      $("openNewTabLink").href = url;
      $("fallbackOpen").href = url;
    }

    function showViewer() {
      $("emptyState").classList.add("hidden");
      $("viewerShell").classList.remove("hidden");
      $("lockBtn").classList.remove("hidden");
      $("openNewTabLink").classList.remove("hidden");
    }

    function hideViewer() {
      $("viewerShell").classList.add("hidden");
      $("lockBtn").classList.add("hidden");
      $("openNewTabLink").classList.add("hidden");
      $("fallback").classList.add("hidden");
      $("embedStatus").textContent = "";
      $("viewerSub").textContent = "";

      const frame = $("projectFrame");
      frame.removeAttribute("src");
    }

    function setEmbedStatus(text) {
      $("embedStatus").textContent = text || "";
    }

    /*************************************************************
     * Cursor (matches your site)
     *************************************************************/
    /*************************************************************
 * Cursor (matches your site)
 *************************************************************/
function initCursor() {
  // Only use the custom cursor if there's a fine pointer (mouse/trackpad)
  if (!window.matchMedia || !window.matchMedia("(pointer: fine)").matches) return;

  const cursor = $("cursor");
  if (!cursor) return;
  const body = document.body;

  const setCustomCursorEnabled = (enabled) => {
    body.classList.toggle("custom-cursor", enabled);
    cursor.classList.toggle("hidden", !enabled);
  };

  const moveCursor = (e) => {
    cursor.style.top = `${e.clientY}px`;
    cursor.style.left = `${e.clientX}px`;
  };

  const updateHover = (e) => {
    const hit = e.target && e.target.closest
      ? e.target.closest("a, button, .interactive, input, label, summary")
      : null;
    cursor.classList.toggle("hovered", !!hit);
  };

  window.addEventListener("mousemove", (e) => {
    moveCursor(e);
    updateHover(e);
  });

  window.addEventListener("blur", () => setCustomCursorEnabled(false));
  window.addEventListener("focus", () => setCustomCursorEnabled(true));

  // Show the system cursor over iframes (no mousemove events inside).
  document.querySelectorAll("iframe").forEach((frame) => {
    frame.addEventListener("mouseenter", () => setCustomCursorEnabled(false));
    frame.addEventListener("mouseleave", () => setCustomCursorEnabled(true));
  });

  // Make sure it shows immediately once initialized
  setCustomCursorEnabled(true);
}


    /*************************************************************
     * Portal logic
     *************************************************************/
    const state = {
      clientId: null,
      client: null,
      projectUrl: null,
      unlocked: false,
      loadTimer: null,
      loaded: false,
    };

    function readParams() {
      const params = new URLSearchParams(window.location.search);
      const id = (params.get("id") || "").trim();

      state.clientId = id || null;
      state.client = id && CLIENTS[id] ? CLIENTS[id] : null;
      state.projectUrl = state.client && state.client.projectUrl ? state.client.projectUrl : null;
    }

    function renderContext() {
      const nameEl = $("clientName");
      if (!state.clientId) {
        $("chip").textContent = t("chip.missingId");
        $("contextLine").innerHTML = t("context.missingIdHtml");
        $("clientLogoWrap").classList.add("hidden");
        if (nameEl) nameEl.textContent = t("labels.clientDefault");
        return;
      }
      if (!state.client) {
        $("chip").textContent = t("chip.unknownClient");
        $("contextLine").innerHTML = t("context.unknownIdHtml", { id: escapeHtml(state.clientId) });
        $("clientLogoWrap").classList.add("hidden");
        if (nameEl) nameEl.textContent = t("labels.clientDefault");
        return;
      }

      $("chip").textContent = state.client.name ? state.client.name : state.clientId;
      $("contextLine").textContent = t("context.clientLine", { name: state.client.name || state.clientId });
      if (nameEl) nameEl.textContent = state.client.name || state.clientId || t("labels.clientDefault");

      const logoUrl = state.client.logoUrl;
      const logoWrap = $("clientLogoWrap");
      const logoImg = $("clientLogo");
      if (logoUrl && logoImg && logoWrap) {
        logoImg.src = logoUrl;
        logoWrap.classList.remove("hidden");
      } else if (logoWrap) {
        logoWrap.classList.add("hidden");
      }
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[c]));
    }

    function validateProject() {
  if (!state.projectUrl) return { ok: false, reason: t("status.projectUrlMissing") };

  // Accept:
  // - absolute URLs: https://...
  // - relative paths: /client-safe-preview/hqrz/index.html or client-safe-preview/hqrz/index.html
  let urlObj = safeParseUrl(state.projectUrl);

  if (!urlObj) {
    // Try resolving as relative to the current page location
    try {
      urlObj = new URL(state.projectUrl, window.location.href);
    } catch {
      return { ok: false, reason: t("status.projectUrlInvalid") };
    }
  }

  // While testing locally, allow http://localhost / 127.0.0.1.
  // In production, you can tighten this to https-only.
  const isLocalHost =
    urlObj.hostname === "localhost" ||
    urlObj.hostname === "127.0.0.1" ||
    urlObj.hostname === "0.0.0.0";

  if (urlObj.protocol !== "https:" && !isLocalHost) {
    return { ok: false, reason: t("status.projectUrlHttps") };
  }

  // Domain allowlist (optional)
  const allowedDomains = (state.client && state.client.allowedDomains) ? state.client.allowedDomains : [];
  if (allowedDomains.length > 0 && !hostAllowed(urlObj.hostname, allowedDomains)) {
    return { ok: false, reason: t("status.projectDomainNotAllowed") };
  }

  return { ok: true, url: urlObj.toString(), host: urlObj.hostname };
}


    function startEmbedWatchdog() {
      clearTimeout(state.loadTimer);
      state.loaded = false;
      setEmbedStatus(t("viewer.embed.loading"));

      state.loadTimer = setTimeout(() => {
        if (state.loaded) return;
        setEmbedStatus(t("viewer.embed.blocked"));
        $("fallback").classList.remove("hidden");
      }, 5000);
    }

    function loadProjectIfReady() {
      if (!state.unlocked) return;

      const v = validateProject();
      if (!v.ok) {
        hideViewer();
        $("emptyState").classList.remove("hidden");
        setStatus(t("status.unlockedReason", { reason: v.reason }), "success");
        return;
      }

      showViewer();
      $("fallback").classList.add("hidden");
      $("viewerSub").textContent = v.host;
      updateOpenLinks(v.url);

      const frame = $("projectFrame");
      startEmbedWatchdog();
      frame.src = v.url;
    }

    async function attemptUnlock() {
      if (!state.clientId) {
        setStatus(t("status.missingIdLink"), "error");
        return;
      }
      if (!state.client) {
        setStatus(t("status.unknownClient", { id: state.clientId }), "error");
        return;
      }
      if (!state.client.passwordHashHex || state.client.passwordHashHex === "REPLACE_ME_WITH_SHA256_HEX") {
        setStatus(t("status.missingPasswordHash"), "error");
        return;
      }

      const pw = $("password").value || "";
      if (!pw.trim()) {
        setStatus(t("status.enterPassword"), "error");
        return;
      }

      setStatus(t("status.checking"));
      try {
        const enteredHash = await sha256Hex(pw);
        if (enteredHash !== String(state.client.passwordHashHex).toLowerCase()) {
          setStatus(t("status.wrongPassword"), "error");
          return;
        }

        state.unlocked = true;
        setStatus(t("status.unlocked"), "success");
        $("password").value = "";

        if ($("remember").checked) rememberSet(state.clientId);
        else rememberClear(state.clientId);

        loadProjectIfReady();
      } catch (e) {
        console.error(e);
        setStatus(t("status.unlockError"), "error");
      }
    }

    function lockNow() {
      state.unlocked = false;
      if (state.clientId) rememberClear(state.clientId);
      hideViewer();
      setStatus(t("status.locked"));
      $("emptyState").classList.remove("hidden");
    }

    function renderStatusHint() {
      if (!state.clientId) {
        setStatus(t("status.pageNeedsId"), "error");
      } else if (!state.client) {
        setStatus(t("status.unknownClient", { id: state.clientId }), "error");
      } else {
        const v = validateProject();
        if (!v.ok) {
          setStatus(v.reason, "error");
        } else {
          setStatus(t("status.ready"), "neutral");
        }
      }
    }

    function init() {
      initLanguage();
      initCursor();
      readParams();
      renderContext();

      // Empty state visibility
      $("emptyState").classList.remove("hidden");
      hideViewer();

      // Events
      $("unlockBtn").addEventListener("click", attemptUnlock);
      $("password").addEventListener("keydown", (e) => {
        if (e.key === "Enter") attemptUnlock();
      });

      $("togglePw").addEventListener("click", () => {
        const input = $("password");
        const isPw = input.type === "password";
        input.type = isPw ? "text" : "password";
        $("togglePw").textContent = isPw ? t("gate.toggleHide") : t("gate.toggleShow");
        input.focus();
      });

      $("lockBtn").addEventListener("click", lockNow);

      $("projectFrame").addEventListener("load", () => {
        state.loaded = true;
        clearTimeout(state.loadTimer);
        setEmbedStatus(t("viewer.embed.loaded"));
        $("fallback").classList.add("hidden");
      });

      // Preview sizing
      const setPreviewSize = (mode) => {
        const shell = $("frameShell");
        const frame = $("projectFrame");
        if (!shell || !frame) return;

        if (mode === "desktop") {
          shell.style.maxWidth = "1200px";
          shell.style.marginLeft = "auto";
          shell.style.marginRight = "auto";
          frame.style.height = "80vh";
          frame.style.minHeight = "700px";
          frame.style.maxHeight = "92vh";
        } else if (mode === "tablet") {
          shell.style.maxWidth = "900px";
          shell.style.marginLeft = "auto";
          shell.style.marginRight = "auto";
          frame.style.height = "80vh";
          frame.style.minHeight = "600px";
          frame.style.maxHeight = "90vh";
        } else {
          shell.style.maxWidth = "420px";
          shell.style.marginLeft = "auto";
          shell.style.marginRight = "auto";
          frame.style.height = "80vh";
          frame.style.minHeight = "600px";
          frame.style.maxHeight = "90vh";
        }

        $("sizeMobile")?.classList.toggle("bg-black", mode === "mobile");
        $("sizeMobile")?.classList.toggle("text-[#f4f4f0]", mode === "mobile");
        $("sizeTablet")?.classList.toggle("bg-black", mode === "tablet");
        $("sizeTablet")?.classList.toggle("text-[#f4f4f0]", mode === "tablet");
        $("sizeDesktop")?.classList.toggle("bg-black", mode === "desktop");
        $("sizeDesktop")?.classList.toggle("text-[#f4f4f0]", mode === "desktop");
      };

      $("sizeMobile")?.addEventListener("click", () => setPreviewSize("mobile"));
      $("sizeTablet")?.addEventListener("click", () => setPreviewSize("tablet"));
      $("sizeDesktop")?.addEventListener("click", () => setPreviewSize("desktop"));
      setPreviewSize("mobile");

      // Auto unlock (per client)
      if (state.clientId && rememberValid(state.clientId)) {
        state.unlocked = true;
        setStatus(t("status.unlockedRemembered"), "success");
        loadProjectIfReady();
      } else {
        setStatus("");
      }

      // Show a helpful hint if link is incomplete
      renderStatusHint();
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
